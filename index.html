<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Terminal de Ônibus com Frequência</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .plataforma { margin-bottom: 10px; }
    .ponto { display: inline-block; width: 40px; height: 40px; margin: 2px; text-align: center; line-height: 40px; border: 1px solid #ccc; }
    .livre { background: #b6fcb6; }
    .ocupado { background: #fcbbbb; }
    form { margin-top: 20px; }
  </style>
</head>
<body>

<h2>Terminal de Ônibus – Controle em Tempo Real</h2>
<p><strong>Hora atual:</strong> <span id="relogio"></span></p>

<div id="plataformas"></div>

<h3>Cadastrar nova linha</h3>
<form id="formCadastro">
  <label>Nome da linha: <input type="text" id="nome" required></label><br>
  <label>Chegada: <input type="datetime-local" id="chegada" required></label><br>
  <label>Saída: <input type="datetime-local" id="saida" required></label><br>
  <label>Frequência: 
    <select id="frequencia">
      <option value="unica">Única</option>
      <option value="diaria">Diária</option>
      <option value="semanal">Semanal</option>
    </select>
  </label><br>
  <button type="submit">Cadastrar</button>
</form>

<script>
  const plataformas = Array.from({ length: 8 }, (_, p) =>
    Array.from({ length: 12 }, (_, i) => ({
      ocupado: false,
      ocupadoAte: null,
      linha: null,
      plataforma: p + 1,
      ponto: i + 1,
    }))
  );

  // Guarda os registros de linhas base e instâncias diárias ativadas
  const linhasBase = [];
  const linhasAtivas = [];

  function desenharPlataformas() {
    const div = document.getElementById('plataformas');
    div.innerHTML = '';
    plataformas.forEach((plataforma, idx) => {
      const linhaDiv = document.createElement('div');
      linhaDiv.className = 'plataforma';
      linhaDiv.innerHTML = `<strong>Plataforma ${idx + 1}:</strong>`;
      plataforma.forEach(ponto => {
        const pontoDiv = document.createElement('div');
        pontoDiv.className = 'ponto ' + (ponto.ocupado ? 'ocupado' : 'livre');
        pontoDiv.title = ponto.linha || 'Livre';
        pontoDiv.innerText = ponto.ponto;
        linhaDiv.appendChild(pontoDiv);
      });
      div.appendChild(linhaDiv);
    });
  }

  // Retorna a diferença em dias, ignorando horas/minutos
  function diffDias(d1, d2) {
    const umDia = 1000 * 60 * 60 * 24;
    const d1utc = Date.UTC(d1.getFullYear(), d1.getMonth(), d1.getDate());
    const d2utc = Date.UTC(d2.getFullYear(), d2.getMonth(), d2.getDate());
    return Math.floor((d2utc - d1utc) / umDia);
  }

  function cloneDate(d) {
    return new Date(d.getTime());
  }

  function ajustarDataBaseParaHoje(dataBase) {
    const hoje = new Date();
    const base = new Date(dataBase);
    base.setFullYear(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
    return base;
  }

  function ativarLinhas() {
    const agora = new Date();

    linhasBase.forEach(linha => {
      if (linha.frequencia === 'unica') {
        // ativa só uma vez se estiver no tempo
        if (!linha.ativada && new Date(linha.chegada) <= agora && new Date(linha.saida) > agora) {
          linhasAtivas.push({...linha, alocada: false});
          linha.ativada = true;
        }
      } else if (linha.frequencia === 'diaria') {
        // cria entrada para o dia atual
        const chegadaHoje = ajustarDataBaseParaHoje(linha.chegada);
        const saidaHoje = ajustarDataBaseParaHoje(linha.saida);
        if (new Date(chegadaHoje) <= agora && new Date(saidaHoje) > agora) {
          const existe = linhasAtivas.some(l => l.nome === linha.nome && l.chegada === chegadaHoje.toISOString());
          if (!existe) {
            linhasAtivas.push({
              nome: linha.nome,
              chegada: chegadaHoje.toISOString(),
              saida: saidaHoje.toISOString(),
              frequencia: linha.frequencia,
              alocada: false
            });
          }
        }
      } else if (linha.frequencia === 'semanal') {
        // ativa se o dia da semana bater (exemplo: segunda=1, domingo=0)
        const hojeDia = agora.getDay(); // 0-domingo ... 6-sabado
        // Por simplicidade vamos ativar toda semana no mesmo dia da semana da data base
        const baseDia = new Date(linha.chegada).getDay();
        if (hojeDia === baseDia) {
          const chegadaHoje = ajustarDataBaseParaHoje(linha.chegada);
          const saidaHoje = ajustarDataBaseParaHoje(linha.saida);
          if (new Date(chegadaHoje) <= agora && new Date(saidaHoje) > agora) {
            const existe = linhasAtivas.some(l => l.nome === linha.nome && l.chegada === chegadaHoje.toISOString());
            if (!existe) {
              linhasAtivas.push({
                nome: linha.nome,
                chegada: chegadaHoje.toISOString(),
                saida: saidaHoje.toISOString(),
                frequencia: linha.frequencia,
                alocada: false
              });
            }
          }
        }
      }
    });
  }

  function atualizarRelogio() {
    const agora = new Date();
    document.getElementById('relogio').innerText = agora.toLocaleString();

    // liberar pontos que passaram da hora de saída
    plataformas.forEach(plataforma => {
      plataforma.forEach(ponto => {
        if (ponto.ocupado && new Date(ponto.ocupadoAte) <= agora) {
          ponto.ocupado = false;
          ponto.linha = null;
          ponto.ocupadoAte = null;
        }
      });
    });

    ativarLinhas();

    // verificar se há linhas para alocar
    linhasAtivas.forEach(linha => {
      const chegada = new Date(linha.chegada);
      const saida = new Date(linha.saida);

      if (!linha.alocada && chegada <= agora && saida > agora) {
        const pontoLivre = plataformas.flat().find(p => !p.ocupado);
        if (pontoLivre) {
          pontoLivre.ocupado = true;
          pontoLivre.ocupadoAte = linha.saida;
          pontoLivre.linha = linha.nome;
          linha.alocada = true;
        }
      }
    });

    desenharPlataformas();
  }

  setInterval(atualizarRelogio, 1000);

  document.getElementById('formCadastro').addEventListener('submit', e => {
    e.preventDefault();
    const nome = document.getElementById('nome').value;
    const chegada = document.getElementById('chegada').value;
    const saida = document.getElementById('saida').value;
    const frequencia = document.getElementById('frequencia').value;

    linhasBase.push({ nome, chegada, saida, frequencia, ativada: false });

    document.getElementById('formCadastro').reset();
    alert('Linha cadastrada com sucesso!');
  });

  desenharPlataformas();
</script>

</body>
</html>
